<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>游戏余额充值</title>
    <link rel="stylesheet" href="css.css">
</head>
<body>
<div>
    <ul id="rate">
        <li>
            <span class="label">我的地址:</span>
            <span id="myAddress"></span>
        </li>
        <li>
            <span class="label">我的token余额:</span>
            <span class="myBalance"></span>
        </li>
        <li>
            <span class="label">当前游戏名称:</span>
            <span class="name">幸运星</span>
        </li>
        <li>
            <span class="label">当前游戏地址:</span>
            <span class="addr"></span>
        </li>
        <li>
            <span class="label">当前游戏token余额:</span>
            <span class="balance"></span>
        </li>
        <li>
            <span class="label">请输入充值金额:</span>
            <span class="money">
                  <input type="text" id="money" placeholder="请输入充值金额:">
            </span>
        </li>
        <li style="text-align: center">
            <button type="button" id="setBtn">充值</button>
        </li>
        <li>
            <span class="warn"></span>
        </li>
    </ul>
</div>
<script src="jquery_1.12.4_jquery.min.js"></script>
<script src="chain3.js"></script>
<script src="linkNet.js"></script>
<script>
    let myBalance = $(".myBalance");
    let addr = $(".addr");
    let balance = $(".balance");

    let money = $("#money");

    addr.html(conAddr);
    setTimeout(() => {
        setLeader();
    }, 1000);

    function setLeader() {
        getJson().then(() => {
            getData();
        });
        setBtn.on("click", () => {
            if (money.val() === "") {
                warn.html("充值金额不能为空");
                setWarn(true);
                return;
            }
            if (isNaN(money.val())) {
                warn.html("金额数字非法");
                setWarn(true);
                return;
            }
            if (parseInt(money.val()) > parseInt(myBalance.html())) {
                warn.html("你的余额不够");
                setWarn(true);
                return;
            }
            setWarn(false);
            setLeaderFun();
        });
    }

    function setLeaderFun() {
        setBtnShow(true);
        getJson().then(() => {
            setWarn(false);
            let mo = web3js.toWei(money.val());
            $tokenContractInstance.transfer(conAddr, mo, {gasPrice: 9000000000}, (err, data) => {
                getData();
                setBtnShow(false);
            });
        });
    }

    function getData() {
        $tokenContractInstance.balanceOf(conAddr, (err, coin) => {
            if (err) {
                console.log(err);
            } else {
                balance.html(web3js.fromWei(coin.toString()));
            }
        });
        $tokenContractInstance.balanceOf(myAddr.html(), (err, coin) => {
            if (err) {
                console.log(err);
            } else {
                myBalance.html(web3js.fromWei(coin.toString()));
            }
        });
    }
</script>
</body>
</html>